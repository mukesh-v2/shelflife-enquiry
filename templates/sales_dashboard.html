<!DOCTYPE html>
<html>
<head>
    <title>Sales Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Add jQuery and Bootstrap JS for dropdown functionality -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="#">
            <img src="{{ url_for('static', filename='envirocare_logo.png') }}" alt="Envirocare Logo" style="max-height: 60px; margin-right: 10px;">
            Shelf Life Study Portal
        </a>
        <div class="ml-auto d-flex align-items-center">
            <span class="text-white mr-3">Hello, {{ session.get('username', 'User') }}</span>
            <div class="dropdown mr-2">
                <button class="btn btn-light dropdown-toggle" type="button" id="analyticsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-chart-bar mr-1"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="analyticsDropdown">
                    <a class="dropdown-item" href="/analytics">Dashboard Analytics</a>
                    <a class="dropdown-item" href="/mis-export">MIS</a>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="accountDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-user-circle mr-1"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="accountDropdown">
                    <a class="dropdown-item" href="/dashboard">Dashboard</a>
                    <a class="dropdown-item" href="/logout">Logout</a>
                </div>
            </div>
        </div>
    </div>
</nav>

    <div class="container">
        <h2 class="my-4">Enquiries Dashboard</h2>
        
        <!-- Filter Form -->
        <form method="GET" class="mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" name="company" class="form-control" 
                               placeholder="Search by company..." 
                               value="{{ request.args.get('company', '') }}">
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-brand">Search</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <!-- Enquiries Table -->
        <div class="card">
            <div class="card-body">
                <!-- Table Info and Per Page Selector -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <span class="text-muted">Showing {{ showing_from }} to {{ showing_to }} of {{ total_enquiries }} entries</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <label for="perPageSelect" class="mr-2 mb-0">Rows per page:</label>
                        <select id="perPageSelect" class="form-control form-control-sm" style="width: auto;">
                            <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <span>Company</span>
                                        <div class="dropdown ml-1">
                                            <button class="btn btn-sm btn-link p-0"
                                                    type="button"
                                                    id="companyFilterDropdown"
                                                    data-toggle="dropdown"
                                                    aria-haspopup="true"
                                                    aria-expanded="false">
                                                <i class="fas fa-filter {% if request.args.get('company_filter') %}text-success{% endif %}"></i>
                                            </button>
                                            <div class="dropdown-menu" aria-labelledby="companyFilterDropdown">
                                                <a class="dropdown-item {% if not request.args.get('company_filter') %}active{% endif %}"
                                                   href="{{ url_for('dashboard', stage=request.args.get('stage', ''), product_filter=request.args.get('product_filter', ''), page=1) }}">All Companies</a>
                                                <div class="dropdown-divider"></div>
                                                {% for company_name in unique_companies %}
                                                <a class="dropdown-item {% if request.args.get('company_filter') == company_name %}active{% endif %}"
                                                   href="{{ url_for('dashboard', company_filter=company_name, stage=request.args.get('stage', ''), product_filter=request.args.get('product_filter', ''), page=1) }}">{{ company_name }}</a>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <span>Product</span>
                                        <div class="dropdown ml-1">
                                            <button class="btn btn-sm btn-link p-0"
                                                    type="button"
                                                    id="productFilterDropdown"
                                                    data-toggle="dropdown"
                                                    aria-haspopup="true"
                                                    aria-expanded="false">
                                                <i class="fas fa-filter {% if request.args.get('product_filter') %}text-success{% endif %}"></i>
                                            </button>
                                            <div class="dropdown-menu" aria-labelledby="productFilterDropdown">
                                                <a class="dropdown-item {% if not request.args.get('product_filter') %}active{% endif %}"
                                                   href="{{ url_for('dashboard', stage=request.args.get('stage', ''), company_filter=request.args.get('company_filter', ''), page=1) }}">All Products</a>
                                                <div class="dropdown-divider"></div>
                                                {% for product_name in unique_products %}
                                                <a class="dropdown-item {% if request.args.get('product_filter') == product_name %}active{% endif %}"
                                                   href="{{ url_for('dashboard', product_filter=product_name, stage=request.args.get('stage', ''), company_filter=request.args.get('company_filter', ''), page=1) }}">{{ product_name }}</a>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <span>Stage</span>
                                        <div class="dropdown ml-1">
                                            <button class="btn btn-sm btn-link p-0" 
                                                    type="button" 
                                                    id="stageFilterDropdown" 
                                                    data-toggle="dropdown" 
                                                    aria-haspopup="true" 
                                                    aria-expanded="false">
                                                <i class="fas fa-filter {% if request.args.get('stage') %}text-success{% endif %}"></i>
                                            </button>
                                            <div class="dropdown-menu" aria-labelledby="stageFilterDropdown">
                                                <a class="dropdown-item {% if not request.args.get('stage') %}active{% endif %}" 
                                                   href="{{ url_for('dashboard', company=request.args.get('company', ''), company_filter=request.args.get('company_filter', ''), product_filter=request.args.get('product_filter', ''), page=1) }}">All Stages</a>
                                                <div class="dropdown-divider"></div>
                                                <a class="dropdown-item {% if request.args.get('stage') == 'Enquiry Received' %}active{% endif %}" 
                                                   href="{{ url_for('dashboard', company=request.args.get('company', ''), stage='Enquiry Received', company_filter=request.args.get('company_filter', ''), product_filter=request.args.get('product_filter', ''), page=1) }}">Enquiry Received</a>
                                                <a class="dropdown-item {% if request.args.get('stage') == 'Qualified' %}active{% endif %}" 
                                                   href="{{ url_for('dashboard', company=request.args.get('company', ''), stage='Qualified', company_filter=request.args.get('company_filter', ''), product_filter=request.args.get('product_filter', ''), page=1) }}">Qualified</a>
                                                <a class="dropdown-item {% if request.args.get('stage') == 'Unqualified' %}active{% endif %}" 
                                                   href="{{ url_for('dashboard', company=request.args.get('company', ''), stage='Unqualified', company_filter=request.args.get('company_filter', ''), product_filter=request.args.get('product_filter', ''), page=1) }}">Unqualified</a>
                                                <a class="dropdown-item {% if request.args.get('stage') == 'Converted' %}active{% endif %}" 
                                                   href="{{ url_for('dashboard', company=request.args.get('company', ''), stage='Converted', company_filter=request.args.get('company_filter', ''), product_filter=request.args.get('product_filter', ''), page=1) }}">Converted</a>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th>Created At</th>
                                <th>Actions</th>
                                <th>Sales POC</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for enquiry in enquiries %}
                            <tr>
                                <td>{{ enquiry.contact_info.company }}</td>
                                <td>{{ enquiry.products | map(attribute='product_name') | join(', ') }}</td>
                                <td>
                                    <span class="badge badge-primary">{{ enquiry.current_stage }}</span>
                                </td>
                                <td>{{ enquiry.created_at | to_ist}}</td>
                                <td>
                                    <a href="{{ url_for('enquiry_detail', id=enquiry._id) }}" 
                                       class="btn btn-sm btn-outline-primary">View</a>
                                </td>
                                <td>{{ enquiry.guide_by | default("NA") }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">No enquiries found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                {% if total_pages > 1 %}
                <nav aria-label="Table pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        <!-- Previous Button -->
                        <li class="page-item {% if not has_prev %}disabled{% endif %}">
                            <a class="page-link" href="{% if has_prev %}{{ url_for('dashboard', page=page-1, per_page=per_page, company=request.args.get('company', ''), company_filter=request.args.get('company_filter', ''), product_filter=request.args.get('product_filter', ''), stage=request.args.get('stage', '')) }}{% else %}#{% endif %}" 
                               aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>

                        <!-- Page Numbers -->
                        <!-- With this (the values are now calculated in backend): -->
                        <!-- start_page and end_page are now passed from backend -->
                        
                        {% if start_page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('dashboard', page=1, per_page=per_page, company=request.args.get('company', ''), company_filter=request.args.get('company_filter', ''), product_filter=request.args.get('product_filter', ''), stage=request.args.get('stage', '')) }}">1</a>
                        </li>
                        {% if start_page > 2 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                        {% endif %}

                        {% for page_num in range(start_page, end_page + 1) %}
                        <li class="page-item {% if page_num == page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('dashboard', page=page_num, per_page=per_page, company=request.args.get('company', ''), company_filter=request.args.get('company_filter', ''), product_filter=request.args.get('product_filter', ''), stage=request.args.get('stage', '')) }}">{{ page_num }}</a>
                        </li>
                        {% endfor %}

                        {% if end_page < total_pages %}
                        {% if end_page < total_pages - 1 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('dashboard', page=total_pages, per_page=per_page, company=request.args.get('company', ''), company_filter=request.args.get('company_filter', ''), product_filter=request.args.get('product_filter', ''), stage=request.args.get('stage', '')) }}">{{ total_pages }}</a>
                        </li>
                        {% endif %}

                        <!-- Next Button -->
                        <li class="page-item {% if not has_next %}disabled{% endif %}">
                            <a class="page-link" href="{% if has_next %}{{ url_for('dashboard', page=page+1, per_page=per_page, company=request.args.get('company', ''), company_filter=request.args.get('company_filter', ''), product_filter=request.args.get('product_filter', ''), stage=request.args.get('stage', '')) }}{% else %}#{% endif %}" 
                               aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Handle per-page selector change
        document.getElementById('perPageSelect').addEventListener('change', function() {
            const perPage = this.value;
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('per_page', perPage);
            currentUrl.searchParams.set('page', '1'); // Reset to first page when changing per_page
            window.location.href = currentUrl.toString();
        });

        // Add some custom styling for better pagination appearance
        document.addEventListener('DOMContentLoaded', function() {
            // Add hover effects to pagination buttons
            const paginationLinks = document.querySelectorAll('.pagination .page-link');
            paginationLinks.forEach(link => {
                link.addEventListener('mouseenter', function() {
                    if (!this.closest('.page-item').classList.contains('disabled')) {
                        this.style.backgroundColor = '#e9ecef';
                    }
                });
                link.addEventListener('mouseleave', function() {
                    if (!this.closest('.page-item').classList.contains('disabled')) {
                        this.style.backgroundColor = '';
                    }
                });
            });
        });
    </script>
    {% include 'loading_overlay.html' %}

    <script>
        // Global loading functions
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
    
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    
        // Handle per-page selector change with loading
        document.getElementById('perPageSelect').addEventListener('change', function() {
            showLoading();
            const perPage = this.value;
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('per_page', perPage);
            currentUrl.searchParams.set('page', '1');
            window.location.href = currentUrl.toString();
        });
    
        // Handle pagination clicks with loading
        document.addEventListener('click', function(e) {
            if (e.target.closest('.pagination .page-link') && !e.target.closest('.page-item.disabled')) {
                showLoading();
            }
        });
    
        // Handle filter dropdown clicks with loading
        document.addEventListener('click', function(e) {
            if (e.target.closest('.dropdown-menu .dropdown-item')) {
                showLoading();
            }
        });
    
        // Handle search form submission with loading
        document.querySelector('form[method="GET"]').addEventListener('submit', function() {
            showLoading();
        });
    
        // Hide loading when page is fully loaded
        window.addEventListener('load', function() {
            hideLoading();
        });
    
        // Add hover effects to pagination buttons
        document.addEventListener('DOMContentLoaded', function() {
            const paginationLinks = document.querySelectorAll('.pagination .page-link');
            paginationLinks.forEach(link => {
                link.addEventListener('mouseenter', function() {
                    if (!this.closest('.page-item').classList.contains('disabled')) {
                        this.style.backgroundColor = '#e9ecef';
                    }
                });
                link.addEventListener('mouseleave', function() {
                    if (!this.closest('.page-item').classList.contains('disabled')) {
                        this.style.backgroundColor = '';
                    }
                });
            });
        });
    </script>
</body>
</html>
